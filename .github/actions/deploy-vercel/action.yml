name: 'Deploy to Vercel'
description: 'Deploy website to Vercel (preview or production)'

inputs:
  vercel-token:
    description: 'Vercel deployment token'
    required: true
  vercel-org-id:
    description: 'Vercel organization ID'
    required: true
  vercel-project-id:
    description: 'Vercel project ID'
    required: true
  production:
    description: 'Deploy to production'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for PR comments'
    required: false
  working-directory:
    description: 'Working directory for Vercel deployment'
    required: false
    default: '.'

outputs:
  preview-url:
    description: 'Preview URL of the deployment'
    value: ${{ steps.deploy.outputs.preview-url }}

runs:
  using: 'composite'
  steps:
    - name: ðŸš€ Deploy to Vercel
      id: deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ inputs.vercel-token }}
        vercel-org-id: ${{ inputs.vercel-org-id }}
        vercel-project-id: ${{ inputs.vercel-project-id }}
        vercel-args: ${{ inputs.production == 'true' && '--prod' || '' }}
        working-directory: ${{ inputs.working-directory }}
        scope: ${{ inputs.vercel-org-id }}

    - name: ðŸ’¬ Comment PR with preview URL
      if: inputs.production == 'false' && inputs.github-token != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const previewUrl = '${{ steps.deploy.outputs.preview-url }}';
          
          // Trouver la PR associÃ©e Ã  cette branche
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: context.repo.owner + ':' + context.ref.replace('refs/heads/', ''),
            state: 'open'
          });
          
          if (prs.length > 0) {
            const prNumber = prs[0].number;
            
            const comment = `## ðŸš€ Preview Deployment Ready!
          
          Your website changes have been deployed to Vercel:
          
          **ðŸ”— Preview URL:** ${previewUrl}
          
          ### âœ… Quality Checks Passed
          - ðŸ” Lint & Type check âœ…
          - ðŸŽ¨ Design system tokens validation âœ…  
          - ðŸ—ï¸ Build successful âœ…
          
          ### ðŸ“± Test your changes:
          - Desktop & Mobile responsive design
          - Component behavior & styling
          - Theme switching functionality
          - Navigation and routing
          
          ---
          
          > ðŸ¤– *Preview updates automatically with each push*
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });
          }

    - name: ðŸŽ‰ Comment last merged PR (production only)
      if: inputs.production == 'true' && inputs.github-token != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const productionUrl = '${{ steps.deploy.outputs.preview-url }}';
          
          // Chercher la derniÃ¨re PR mergÃ©e
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            sort: 'updated',
            direction: 'desc',
            per_page: 1
          });
          
          if (prs.length > 0 && prs[0].merged_at) {
            const prNumber = prs[0].number;
            
            const comment = `## ðŸŽ‰ Deployed to Production!
          
          Your website changes are now live in production:
          
          **ðŸŒŸ Production URL:** ${productionUrl}
          
          ### ðŸš€ Deployment Summary
          - âœ… Quality checks passed
          - âœ… Design system tokens validated
          - âœ… Build successful  
          - âœ… Production deployment complete
          
          ### ðŸŽŠ Great work!
          Your changes have been successfully deployed and are now available to users.
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });
          }