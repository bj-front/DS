name: Auto Pull Request

on:
  push:
    branches-ignore: [main]
  workflow_run:
    workflows: ["Design System CI/CD", "Website CI/CD"]
    types: [completed]
    branches-ignore: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: ðŸš€ Create Pull Request
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success' &&
      !contains(github.head_ref, 'dependabot')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ” Check if PR already exists
        id: check-pr
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # VÃ©rifier si une PR existe dÃ©jÃ  pour cette branche
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          # Analyser les changements pour gÃ©nÃ©rer un titre intelligent
          COMMITS=$(git log --oneline main..$BRANCH_NAME | head -5)
          
          # GÃ©nÃ©rer un titre basÃ© sur les commits
          if echo "$COMMITS" | grep -q "feat"; then
            PR_TITLE="ðŸš€ feat: $(echo "$COMMITS" | head -1 | cut -d' ' -f2- | sed 's/ðŸ”§ //g' | sed 's/feat: //g')"
          elif echo "$COMMITS" | grep -q "fix"; then
            PR_TITLE="ðŸ”§ fix: $(echo "$COMMITS" | head -1 | cut -d' ' -f2- | sed 's/ðŸ”§ //g' | sed 's/fix: //g')"
          elif echo "$COMMITS" | grep -q "chore"; then
            PR_TITLE="ðŸ“¦ chore: $(echo "$COMMITS" | head -1 | cut -d' ' -f2- | sed 's/ðŸ“¦ //g' | sed 's/chore: //g')"
          else
            PR_TITLE="âœ¨ $(echo "$COMMITS" | head -1 | cut -d' ' -f2-)"
          fi
          
          # GÃ©nÃ©rer le body de la PR
          cat > pr_body.md << 'EOF'
          ## ðŸŽ¯ Changes

          Voici les modifications apportÃ©es dans cette feature branch :
          
          ### ðŸ“‹ Commits inclus :
          ```
          EOF
          
          echo "$COMMITS" >> pr_body.md
          
          cat >> pr_body.md << 'EOF'
          ```

          ## âœ… Validations
          
          - âœ… **Design System CI/CD** - Passed
          - âœ… **Website CI/CD** - Passed  
          - âœ… **Code Quality** - ESLint + TypeScript checks
          - âœ… **Pre-commit hooks** - Working

          ## ðŸ§ª Tests
          
          Tous les tests automatisÃ©s sont passÃ©s avec succÃ¨s.

          ## ðŸ“‹ Impact

          Cette PR est prÃªte pour review et merge.
          
          ---
          *ðŸ¤– Pull Request crÃ©Ã©e automatiquement par GitHub Actions*
          EOF

          # CrÃ©er la PR
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr_body.md \
            --head "$BRANCH_NAME" \
            --base main \
            --label "auto-generated" \
            --label "ready-for-review"
            
          echo "âœ… Pull Request crÃ©Ã©e automatiquement !"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Add comment if PR exists
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')
          
          gh pr comment "$PR_NUMBER" --body "ðŸŽ‰ **Nouvelles validations passÃ©es !**

          âœ… Design System CI/CD - Success
          âœ… Website CI/CD - Success
          âœ… Tous les checks sont verts
          
          Cette PR est Ã  jour et prÃªte pour review ! ðŸš€"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}