name: Auto Pull Request

on:
  push:
    branches-ignore: 
      - main
      - develop

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if PR exists
        id: check-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # VÃ©rifier si une PR existe dÃ©jÃ  pour cette branche
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Utiliser GitHub CLI pour vÃ©rifier les PRs existantes
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq length)
          
          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "PR already exists for branch $BRANCH_NAME"
            echo "create_pr=false" >> $GITHUB_OUTPUT
          else
            echo "No PR found for branch $BRANCH_NAME"
            echo "create_pr=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Detect change type
        id: detect-changes
        if: steps.check-pr.outputs.create_pr == 'true'
        run: |
          # Analyser les changements pour gÃ©nÃ©rer un titre intelligent
          COMPONENT_CHANGES=$(git diff --name-only origin/main...HEAD | grep -E "packages/utopia/src/components/" | wc -l)
          TOKEN_CHANGES=$(git diff --name-only origin/main...HEAD | grep -E "packages/utopia/src/tokens/" | wc -l)
          NEW_COMPONENTS=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep -E "packages/utopia/src/components/.*\.vue$" | grep -v "demo/" | wc -l)
          
          # GÃ©nÃ©rer le titre et la description
          if [ "$NEW_COMPONENTS" -gt 0 ]; then
            TITLE="feat: add new component(s)"
            TYPE="ðŸ†• New Component"
          elif [ "$COMPONENT_CHANGES" -gt 0 ]; then
            TITLE="feat: update component(s)"
            TYPE="ðŸ”§ Component Update"
          elif [ "$TOKEN_CHANGES" -gt 0 ]; then
            TITLE="feat: update design tokens"
            TYPE="ðŸŽ¨ Design Tokens"
          else
            TITLE="feat: update design system"
            TYPE="ðŸ“¦ General Update"
          fi
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "component_changes=$COMPONENT_CHANGES" >> $GITHUB_OUTPUT
          echo "token_changes=$TOKEN_CHANGES" >> $GITHUB_OUTPUT
          echo "new_components=$NEW_COMPONENTS" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.create_pr == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          TITLE="${{ steps.detect-changes.outputs.title }}"
          TYPE="${{ steps.detect-changes.outputs.type }}"
          COMPONENT_CHANGES="${{ steps.detect-changes.outputs.component_changes }}"
          TOKEN_CHANGES="${{ steps.detect-changes.outputs.token_changes }}"
          NEW_COMPONENTS="${{ steps.detect-changes.outputs.new_components }}"
          
          # GÃ©nÃ©rer le corps de la PR
          cat > pr_body.md << EOF
          ## $TYPE
          
          **Branch:** \`$BRANCH_NAME\`
          
          ### ðŸ“Š Changes Summary
          - ðŸ”§ Components changed: **$COMPONENT_CHANGES**
          - ðŸŽ¨ Tokens changed: **$TOKEN_CHANGES**
          - ðŸ†• New components: **$NEW_COMPONENTS**
          
          ### ðŸ” Files Changed
          \`\`\`
          $(git diff --name-only origin/main...HEAD | head -10)
          \`\`\`
          
          ### âœ… Checklist
          
          - [ ] ðŸ—ï¸ Build passes
          - [ ] ðŸ§ª Tests pass  
          - [ ] ðŸ“ Changeset created (auto-generated)
          - [ ] ðŸŽ¨ Components follow design system guidelines
          - [ ] ðŸ“š Documentation updated (if needed)
          - [ ] ðŸ” Code review requested
          
          ### ðŸš€ Next Steps
          
          1. **Review the changes** in the Files tab
          2. **Test the components** in Storybook/Demo
          3. **Check the changeset** for proper versioning
          4. **Approve & merge** when ready
          
          ---
          
          > ðŸ¤– *This PR was created automatically by GitHub Actions*
          > ðŸ“¦ *A changeset will be auto-generated for version management*
          EOF
          
          # Essayer d'obtenir l'auteur du commit pour l'assignation
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%ae' | cut -d'@' -f1)
          
          # CrÃ©er la PR avec GitHub CLI
          if gh api users/"$COMMIT_AUTHOR" >/dev/null 2>&1; then
            echo "ðŸ“ Assigning PR to $COMMIT_AUTHOR"
            gh pr create \
              --title "$TITLE" \
              --body-file pr_body.md \
              --base main \
              --head "$BRANCH_NAME" \
              --assignee "$COMMIT_AUTHOR" \
              --label "auto-created,design-system"
          else
            echo "ðŸ“ Creating PR without assignee (user $COMMIT_AUTHOR not found)"
            gh pr create \
              --title "$TITLE" \
              --body-file pr_body.md \
              --base main \
              --head "$BRANCH_NAME" \
              --label "auto-created,design-system"
          fi
            
          echo "âœ… Pull Request created successfully!"
          
      - name: Add PR comment
        if: steps.check-pr.outputs.create_pr == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ajouter un commentaire avec des liens utiles
          BRANCH_NAME="${{ github.ref_name }}"
          
          cat > comment.md << EOF
          ## ðŸ”— Quick Links
          
          - ðŸ“š [Storybook Preview](https://your-storybook-url.com)
          - ðŸŒ [Demo Website](https://your-demo-url.com)
          - ðŸ“¦ [npm Package](https://www.npmjs.com/package/@club-employes/utopia)
          - ðŸ—ï¸ [GitHub Actions](https://github.com/${{ github.repository }}/actions)
          
          ## ðŸ¤– Automation Status
          
          - âœ… Auto-changeset: Will be created on next push
          - âœ… CI/CD: Will run automatically  
          - âœ… Release: Will publish to npm after merge
          
          Ready for review! ðŸš€
          EOF
          
          gh pr comment "$BRANCH_NAME" --body-file comment.md