echo "🔍 Exécution des vérifications pre-commit..."

# Récupère les fichiers staged
CHANGED_FILES=$(git diff --cached --name-only)

# Détecte les changements pour le website
if echo "$CHANGED_FILES" | grep -q "^apps/utopia-website/.*\.(js|ts|vue)$"; then
    echo "🔍 Vérifications website..."
    npx turbo lint type-check --filter=utopia-website
fi

# Détecte les changements pour le design system
if echo "$CHANGED_FILES" | grep -q "^packages/utopia/"; then
    echo "🎨 Vérifications design system..."
    npx turbo lint type-check build:tokens --filter=@club-employes/utopia
    
    # Crée automatiquement un changeset si nécessaire
    echo "📝 Création automatique du changeset..."
    
    # Créer le changeset directement
    TIMESTAMP=$(date +%s)
    CHANGESET_FILE=".changeset/auto-${TIMESTAMP}.md"
    BRANCH_NAME=$(git branch --show-current)
    
    cat > "$CHANGESET_FILE" << EOF
---
"@club-employes/utopia": minor
---

Updates from branch ${BRANCH_NAME}:
- Design system components updated
EOF
    
    echo "✅ Changeset créé : auto-${TIMESTAMP}.md"
    git add "$CHANGESET_FILE"
fi

# Validation globale si changements tokens
if echo "$CHANGED_FILES" | grep -qE "^(apps/utopia-website/.*|packages/utopia/src/tokens/.*)$"; then
    echo "🎨 Validation des tokens du design system..."
    npx turbo validate:design-system --filter=utopia-website
fi

echo "✅ Toutes les vérifications sont passées !"
