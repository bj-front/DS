echo "üîç Ex√©cution des v√©rifications pre-commit..."

# R√©cup√®re les fichiers staged
CHANGED_FILES=$(git diff --cached --name-only)

# D√©tecte les changements pour le website
if echo "$CHANGED_FILES" | grep -q "^apps/utopia-website/.*\.(js|ts|vue)$"; then
    echo "üîç V√©rifications website..."
    npx turbo lint type-check --filter=utopia-website
fi

# D√©tecte les changements pour le design system
if echo "$CHANGED_FILES" | grep -q "^packages/utopia/.*\.(js|ts|vue)$"; then
    echo "üé® V√©rifications design system..."
    npx turbo lint type-check build:tokens --filter=@club-employes/utopia
    
    # Cr√©e automatiquement un changeset si n√©cessaire
    echo "üìù Cr√©ation automatique du changeset..."
    node scripts/auto-changeset.js
    
    # V√©rifier si un nouveau changeset a √©t√© cr√©√© et l'ajouter au commit
    NEW_CHANGESETS=$(git diff --cached --name-only | grep "^\.changeset/.*\.md$")
    if [ -n "$NEW_CHANGESETS" ]; then
        echo "‚úÖ Changeset cr√©√© et ajout√© au commit"
        git add $NEW_CHANGESETS
    fi
fi

# Validation globale si changements tokens
if echo "$CHANGED_FILES" | grep -qE "^(apps/utopia-website/.*|packages/utopia/src/tokens/.*)$"; then
    echo "üé® Validation des tokens du design system..."
    npx turbo validate:design-system --filter=utopia-website
fi

echo "‚úÖ Toutes les v√©rifications sont pass√©es !"
